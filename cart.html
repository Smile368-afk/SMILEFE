<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cart Checkout</title>
  <style>
    body {
      background-color: #0d0d0d;
      color: #ffffff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      color: #00ffcc;
    }
    .cart-item {
      display: flex;
      align-items: center;
      background-color: #1a1a1a;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
    }
    .cart-item img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      margin-right: 15px;
      border-radius: 4px;
    }
    .cart-item button {
      margin-left: auto;
      background-color: #ff4444;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 4px;
    }
    form {
      margin-top: 30px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    input, textarea, select {
      padding: 10px;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      width: 100%;
    }
    button[type="submit"] {
      background-color: #00cc66;
      color: white;
      padding: 10px;
      font-size: 18px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
    }
    #total-price {
      font-size: 20px;
      margin-top: 15px;
    }
  </style>
</head>
<body>

  <h1>Your Cart</h1>
  <div id="cart-items"></div>
  <h2 id="total-price">Total: Rs.0</h2>

  <form id="checkout-form" enctype="multipart/form-data">
    <input type="text" id="name" placeholder="Your Name" required />
    <input type="text" id="contact" placeholder="Contact Number" required />
    <textarea id="address" placeholder="Delivery Address" required></textarea>

    <select id="paymentMethod" required>
      <option value="">Select Payment Method</option>
      <option value="Cash on Delivery">Cash on Delivery</option>
      <option value="EasyPaisa">EasyPaisa</option>
    </select>

    <div id="screenshot-field" style="display: none;">
      <label>Upload EasyPaisa Screenshot:</label>
      <input type="file" id="screenshot" accept="image/*" />
    </div>

    <button type="submit">Confirm Order</button>
  </form>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const cartItems = JSON.parse(localStorage.getItem("cart")) || [];
      const cartContainer = document.getElementById("cart-items");
      const totalPriceEl = document.getElementById("total-price");
      const checkoutForm = document.getElementById("checkout-form");
      const screenshotField = document.getElementById("screenshot-field");
      const screenshotInput = document.getElementById("screenshot");
      const paymentMethodSelect = document.getElementById("paymentMethod");

      // Render Cart Items
      function renderCart() {
        cartContainer.innerHTML = "";
        let total = 0;

        cartItems.forEach((item, index) => {
          const itemEl = document.createElement("div");
          itemEl.className = "cart-item";
          itemEl.innerHTML = `
            <img src="${item.image}" alt="${item.product}" />
            <div>
              <strong>${item.product}</strong><br/>
              Size: ${item.size}<br/>
              Quantity: ${item.quantity}<br/>
              Price: Rs.${item.price}
            </div>
            <button onclick="removeItem(${index})">Remove</button>
          `;
          cartContainer.appendChild(itemEl);
          total += item.price * item.quantity;
        });

        totalPriceEl.textContent = `Total: Rs.${total}`;
      }

      // Remove item from cart
      window.removeItem = function(index) {
        cartItems.splice(index, 1);
        localStorage.setItem("cart", JSON.stringify(cartItems));
        renderCart();
      }

      // Show/Hide screenshot field
      paymentMethodSelect.addEventListener("change", () => {
        screenshotField.style.display = paymentMethodSelect.value === "EasyPaisa" ? "block" : "none";
      });

      // Submit Order
      checkoutForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const name = document.getElementById("name").value.trim();
        const contact = document.getElementById("contact").value.trim();
        const address = document.getElementById("address").value.trim();
        const paymentMethod = paymentMethodSelect.value;

        if (!name || !contact || !address || cartItems.length === 0) {
          alert("Please fill all fields and ensure cart is not empty.");
          return;
        }

        const formData = new FormData();
        formData.append("name", name);
        formData.append("contact", contact);
        formData.append("address", address);
        formData.append("paymentMethod", paymentMethod);
        formData.append("cart", JSON.stringify(cartItems));

        if (paymentMethod === "EasyPaisa" && screenshotInput.files.length > 0) {
          formData.append("screenshot", screenshotInput.files[0]);
        }

        try {
          const res = await fetch("https://smilebe.onrender.com/checkout", {
            method: "POST",
            body: formData,
          });

          const msg = await res.text();

          if (res.ok) {
            alert("✅ Order placed successfully!");
            localStorage.removeItem("cart");
            window.location.reload();
          } else {
            alert("❌ Order failed: " + msg);
          }
        } catch (err) {
          alert("❌ Error submitting order. Try again.");
          console.error(err);
        }
      });

      renderCart();
    });
  </script>

</body>
</html>
